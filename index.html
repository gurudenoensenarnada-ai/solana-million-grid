<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Million Grid en Solana - Compra p√≠xeles y muestra tu proyecto">
  <title>Solana Million Grid</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%); 
      color: #fff; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
      min-height: 100vh;
    }
    header { 
      background: rgba(34, 34, 34, 0.95); 
      padding: 15px 20px; 
      color: gold; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
    }
    .logo { 
      font-size: 32px; 
      font-weight: bold; 
      display: flex; 
      align-items: center; 
      gap: 15px;
    }
    .connectBtn { 
      padding: 10px 20px; 
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none; 
      border-radius: 8px; 
      color: #fff; 
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s;
    }
    .connectBtn:hover { transform: scale(1.05); }
    .connectBtn:disabled { 
      background: #666; 
      cursor: not-allowed;
      transform: none;
    }
    #info { 
      padding: 15px; 
      background: rgba(51, 51, 51, 0.8); 
      text-align: center;
      backdrop-filter: blur(10px);
    }
    #stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
      flex-wrap: wrap;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: gold;
    }
    .stat-label {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
    }
    #gridWrapper { 
      display: flex; 
      justify-content: center; 
      padding: 20px;
    }
    #gridContainer { 
      position: relative; 
      display: inline-block; 
      border: 3px solid #444;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    }
    #canvas { 
      display: block; 
      cursor: pointer; 
      image-rendering: pixelated; 
      background: #555;
    }
    #selectionOverlay { 
      position: absolute; 
      pointer-events: none; 
      display: none; 
      z-index: 20; 
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid cyan;
      box-shadow: 0 0 10px cyan;
    }
    #tooltip { 
      position: absolute; 
      display: none; 
      pointer-events: none; 
      background: rgba(0, 0, 0, 0.95); 
      color: #fff; 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 1px solid gold; 
      z-index: 60; 
      font-size: 14px; 
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
    #selectionInfo { 
      text-align: center; 
      padding: 10px; 
      color: gold; 
      font-weight: bold;
      min-height: 30px;
    }
    #buttons { 
      text-align: center; 
      margin: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    button { 
      padding: 12px 24px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .price-display { 
      color: gold; 
      text-align: center; 
      padding: 12px; 
      margin-bottom: 10px; 
      background: rgba(17, 17, 17, 0.8); 
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
    }
    .owner-badge {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    #paymentStatus { 
      text-align: center; 
      padding: 10px; 
      margin-top: 10px; 
      color: #fff;
      min-height: 24px;
      font-weight: bold;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 13px;
    }
    input[type="text"], input[type="url"], input[type="file"] { 
      width: 100%; 
      padding: 10px; 
      background: #333; 
      border: 1px solid #555; 
      color: #fff; 
      border-radius: 6px; 
      box-sizing: border-box;
      font-size: 14px;
    }
    input:focus {
      outline: none;
      border-color: gold;
    }
    #modalInner { 
      background: rgba(34, 34, 34, 0.98); 
      padding: 25px; 
      border-radius: 12px; 
      border: 2px solid gold; 
      width: 400px; 
      max-width: 90%; 
      margin: auto;
      box-shadow: 0 10px 50px rgba(0,0,0,0.8);
    }
    #loading { 
      position: fixed; 
      inset: 0; 
      background: rgba(0, 0, 0, 0.95); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 300;
      backdrop-filter: blur(5px);
    }
    .spinner { 
      border: 4px solid #333; 
      border-top: 4px solid gold; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 200;
      overflow-y: auto;
    }
    .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .btn-primary {
      background: linear-gradient(135deg, gold 0%, #ffd700 100%);
      color: #000;
    }
    .btn-secondary {
      background: #666;
      color: #fff;
    }
    @media (max-width: 768px) {
      #gridContainer { max-width: 100%; }
      #canvas { max-width: 100%; height: auto; }
      #modalInner { width: 95%; padding: 20px; }
      .logo { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <p style="color:gold;margin-top:15px;font-size:18px;">Cargando grid...</p>
    </div>
  </div>

  <header>
    <div class="logo">SOLANA MILLION DOLLAR</div>
    <div>
      <button id="connectWallet" class="connectBtn">Conectar Wallet</button>
      <span id="walletAddr" style="margin-left:10px;color:#ddd;font-size:13px"></span>
      <span id="ownerBadge" style="display:none;" class="owner-badge">‚≠ê OWNER</span>
    </div>
  </header>

  <div id="info">
    <div id="stats">
      <div class="stat-item">
        <div class="stat-value" id="goldSold">0/2,500</div>
        <div class="stat-label">ü•á Bloques Oro (1 SOL)</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="silverSold">0/3,500</div>
        <div class="stat-label">ü•à Bloques Plata (0.5 SOL)</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="bronzeSold">0/4,000</div>
        <div class="stat-label">ü•â Bloques Bronce (0.1 SOL)</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSales">0</div>
        <div class="stat-label">Total Ventas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="selectionAmount">-</div>
        <div class="stat-label">üí∞ Selecci√≥n Actual (SOL)</div>
      </div>
    </div>
  </div>

  <div id="selectionInfo"></div>

  <div id="buttons">
    <button id="confirmBtn" class="btn-primary" disabled>‚úì Comprar Selecci√≥n</button>
    <button id="cancelBtn" class="btn-secondary">‚úó Cancelar</button>
  </div>

  <div id="gridWrapper">
    <div id="gridContainer">
      <canvas id="canvas" width="1000" height="1000"></canvas>
      <div id="selectionOverlay"></div>
      <div id="tooltip"></div>
    </div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div id="modalInner">
        <h3 style="color:gold;margin:0 0 15px 0;text-align:center">üé® Comprar P√≠xeles</h3>
        
        <div class="price-display">
          Precio total: <span id="totalPrice">0.00</span> SOL
          <div id="ownerPriceNote" style="display:none;color:#FFD700;font-size:14px;margin-top:5px;">
            ‚≠ê Precio especial de owner: 0.0001 SOL/bloque
          </div>
        </div>
        
        <div id="projectForm">
          <div class="form-group">
            <label>Nombre del Proyecto *</label>
            <input type="text" id="projectName" placeholder="Mi Proyecto Incre√≠ble" maxlength="50">
          </div>
          <div class="form-group">
            <label>URL del Proyecto *</label>
            <input type="url" id="projectURL" placeholder="https://miproyecto.com">
          </div>
          <div class="form-group">
            <label>Logo del Proyecto * (PNG, JPG, GIF - m√°x 5MB)</label>
            <input type="file" id="projectLogo" accept="image/*">
          </div>
        </div>
        
        <div id="paymentStatus"></div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="payBtn" class="btn-primary" style="flex:1">üí∞ Pagar y Registrar</button>
          <button id="closeModal" class="btn-secondary" style="flex:1">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
const CANVAS_SIZE=1000,BLOCK_SIZE=10,BLOCKS_PER_SIDE=100,PRICE_GOLD=1,PRICE_SILVER=.5,PRICE_BRONZE=.1,PRICE_OWNER=1e-4,OWNER_WALLET="B7nB9QX1KC4QXp5GMxR8xzh3yzoqp6NjxSwfNBXtgPc1",API_BASE=window.location.origin,GOLD_END=24,SILVER_START=25,SILVER_END=59,BRONZE_START=60,GOLD_TOTAL=2500,SILVER_TOTAL=3500,BRONZE_TOTAL=4e3;
const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),goldSoldSpan=document.getElementById("goldSold"),silverSoldSpan=document.getElementById("silverSold"),bronzeSoldSpan=document.getElementById("bronzeSold"),totalSalesSpan=document.getElementById("totalSales"),selectionAmountSpan=document.getElementById("selectionAmount"),selectionOverlay=document.getElementById("selectionOverlay"),selectionInfo=document.getElementById("selectionInfo"),tooltip=document.getElementById("tooltip"),connectBtn=document.getElementById("connectWallet"),walletAddrSpan=document.getElementById("walletAddr"),ownerBadge=document.getElementById("ownerBadge"),loadingEl=document.getElementById("loading"),confirmBtn=document.getElementById("confirmBtn"),cancelBtn=document.getElementById("cancelBtn");
let blockData=new Array(1e4).fill(null),soldPixels=0,totalSales=0,goldSold=0,silverSold=0,bronzeSold=0,isDragging=!1,startX,startY,endX,endY,selection=null,userPublicKey=null,MERCHANT_WALLET=null,isOwner=!1;
async function loadConfig(){try{const e=await fetch(`${API_BASE}/api/config`),t=await e.json();t.ok&&(MERCHANT_WALLET=t.merchantWallet,console.log("‚úÖ Config:",t.cluster))}catch(e){console.error("Error config:",e)}}
function checkIfOwner(e){return e===OWNER_WALLET}
function getPriceForBlock(e){return isOwner?PRICE_OWNER:"gold"===e?PRICE_GOLD:"silver"===e?PRICE_SILVER:PRICE_BRONZE}
function drawGrid(){ctx.fillStyle="#FFD700",ctx.fillRect(0,0,1e3,250),ctx.fillStyle="#C0C0C0",ctx.fillRect(0,250,1e3,350),ctx.fillStyle="#CD7F32",ctx.fillRect(0,600,1e3,400),ctx.strokeStyle="#333",ctx.lineWidth=1;for(let e=0;e<=1e3;e+=10)ctx.beginPath(),ctx.moveTo(e+.5,0),ctx.lineTo(e+.5,1e3),ctx.stroke();for(let e=0;e<=1e3;e+=10)ctx.beginPath(),ctx.moveTo(0,e+.5),ctx.lineTo(1e3,e+.5),ctx.stroke()}
function getZone(e){return e<=24?"gold":e>=25&&e<=59?"silver":e>=60?"bronze":null}
function getZoneName(e){return isOwner?"‚≠ê OWNER (0.0001 SOL/bloque)":"gold"===e?"ORO (1 SOL/bloque)":"silver"===e?"PLATA (0.5 SOL/bloque)":"bronze"===e?"BRONCE (0.1 SOL/bloque)":""}
function blockIndex(e,t){return 100*t+e}
function isBlockSold(e,t){return!(e<0||t<0||e>=100||t>=100)&&null!==blockData[blockIndex(e,t)]}
function getMousePosInCanvas(e){const t=canvas.getBoundingClientRect();return{rawX:Math.floor((e.clientX-t.left)*(1e3/t.width)),rawY:Math.floor((e.clientY-t.top)*(1e3/t.height)),rect:t}}
async function loadGridFromServer(){console.log("üîÑ Cargando...");try{drawGrid();const e=await fetch(`${API_BASE}/api/sales`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();if(!t||!t.sales)return void console.warn("‚ö†Ô∏è No sales");const o=t.sales;totalSales=o.length,totalSalesSpan.textContent=totalSales,blockData=new Array(1e4).fill(null),goldSold=0,silverSold=0,bronzeSold=0;const l={};o.forEach((e=>{const t=e.metadata;if(!t||!t.selection)return;const o=`${t.name}_${t.logo}`;l[o]||(l[o]={name:t.name,url:t.url,logo:t.logo,blocks:[]});const n=t.selection;for(let e=n.minBlockY;e<n.minBlockY+n.blocksY;e++)for(let t=n.minBlockX;t<n.minBlockX+n.blocksX;t++)l[o].blocks.push({x:t,y:e})}));for(const e of Object.values(l))await loadProjectOnGrid(e);for(let e=0;e<100;e++)for(let t=0;t<100;t++)if(null!==blockData[blockIndex(t,e)]){const o=getZone(e);"gold"===o?goldSold++:"silver"===o?silverSold++:"bronze"===o&&bronzeSold++}goldSoldSpan.textContent=`${goldSold.toLocaleString()}/${GOLD_TOTAL.toLocaleString()}`,silverSoldSpan.textContent=`${silverSold.toLocaleString()}/${SILVER_TOTAL.toLocaleString()}`,bronzeSoldSpan.textContent=`${bronzeSold.toLocaleString()}/${BRONZE_TOTAL.toLocaleString()}`,console.log("‚úÖ Grid cargado")}catch(e){console.error("‚ùå",e),alert("Error cargando grid")}finally{loadingEl.style.display="none"}}
function loadProjectOnGrid(e){return new Promise((t=>{const o=new Image;o.crossOrigin="anonymous",o.onload=function(){let l=1/0,n=1/0,a=-1/0,i=-1/0;e.blocks.forEach((e=>{e.x<l&&(l=e.x),e.y<n&&(n=e.y),e.x>a&&(a=e.x),e.y>i&&(i=e.y)}));const r=10*l,s=10*n,c=10*(a-l+1),d=10*(i-n+1);ctx.drawImage(o,r,s,c,d),e.blocks.forEach((t=>{blockData[blockIndex(t.x,t.y)]={name:e.name,url:e.url,logo:e.logo}})),t()},o.onerror=function(){e.blocks.forEach((t=>{blockData[blockIndex(t.x,t.y)]={name:e.name,url:e.url,logo:e.logo}})),t()},o.src=e.logo}))}
async function connectWallet(){if(!window.solana)return void alert("Instala Phantom");try{connectBtn.disabled=!0,connectBtn.textContent="Conectando...";const e=await window.solana.connect({onlyIfTrusted:!1});userPublicKey=e.publicKey;const t=userPublicKey.toString();isOwner=checkIfOwner(t),walletAddrSpan.textContent=t.slice(0,4)+"..."+t.slice(-4),connectBtn.textContent="Conectado ‚úì",connectBtn.style.background="#28a745",isOwner&&(ownerBadge.style.display="inline-block",console.log("‚≠ê OWNER"))}catch(e){console.error(e),alert("Error: "+e.message),connectBtn.disabled=!1,connectBtn.textContent="Conectar Wallet"}}
connectBtn.onclick=connectWallet;
canvas.addEventListener("mousedown",(e=>{const{rawX:t,rawY:o}=getMousePosInCanvas(e);startX=10*Math.floor(t/10),startY=10*Math.floor(o/10),isDragging=!0,selection=null,selectionInfo.textContent="",selectionAmountSpan.textContent="-",selectionOverlay.style.display="none",confirmBtn.disabled=!0}));
canvas.addEventListener("mousemove",(e=>{handleMove(e),handleHover(e)}));
canvas.addEventListener("mouseup",handleUp);
canvas.addEventListener("mouseleave",(()=>{isDragging=!1}));
function handleMove(e){if(!isDragging)return;const{rawX:t,rawY:o}=getMousePosInCanvas(e);endX=10*Math.floor(t/10),endY=10*Math.floor(o/10);const l=Math.min(startX,endX),n=Math.max(startX,endX),a=Math.min(startY,endY),i=Math.max(startY,endY),r=n-l+10,s=i-a+10,c=l/10,d=a/10,S=n/10,m=i/10,u=getZone(d),f=getZone(m);let y=0;for(let e=d;e<=m;e++)for(let t=c;t<=S;t++)isBlockSold(t,e)&&y++;const g=getPriceForBlock(u);if(u!==f)selectionAmountSpan.textContent="-",selectionInfo.innerHTML="‚ùå No mezcles zonas",selectionOverlay.style.border="3px solid #dc3545";else{const e=r/10*s/10;selectionAmountSpan.textContent=(e*g).toFixed(4),y>0?(selectionInfo.innerHTML=`‚ö†Ô∏è ${r/10}√ó${s/10} | Ocupados: ${y}`,selectionOverlay.style.border="3px solid #dc3545"):(selectionInfo.innerHTML=`‚úì ${r/10}√ó${s/10} (${getZoneName(u)}) | ${(e*g).toFixed(4)} SOL`,selectionOverlay.style.border="3px solid cyan")}const p=canvas.getBoundingClientRect().width/1e3;selectionOverlay.style.display="block",selectionOverlay.style.left=l*p+"px",selectionOverlay.style.top=a*p+"px",selectionOverlay.style.width=r*p+"px",selectionOverlay.style.height=s*p+"px"}
function handleUp(e){if(!isDragging)return;if(isDragging=!1,void 0===endX||void 0===endY)return void(selection=null);const t=Math.min(startX,endX),o=Math.max(startX,endX),l=Math.min(startY,endY),n=Math.max(startY,endY),a=t/10,i=l/10,r=o/10,s=n/10,c=getZone(i);if(c!==getZone(s))return alert("‚ùå No mezcles zonas"),selection=null,selectionOverlay.style.display="none",selectionInfo.textContent="",selectionAmountSpan.textContent="-",void(confirmBtn.disabled=!0);let d=0;for(let e=i;e<=s;e++)for(let t=a;t<=r;t++)isBlockSold(t,e)&&d++;selection={minBlockX:a,minBlockY:i,maxBlockX:r,maxBlockY:s,blocksX:r-a+1,blocksY:s-i+1,soldInSelection:d,zone:c},confirmBtn.disabled=d>0}
function handleHover(e){if(isDragging)return void(tooltip.style.display="none");const{rawX:t,rawY:o,rect:l}=getMousePosInCanvas(e),n=Math.floor(t/10),a=Math.floor(o/10);if(n<0||a<0||n>=100||a>=100)return void(tooltip.style.display="none");const i=blockData[blockIndex(n,a)];if(i){tooltip.textContent=`üöÄ ${i.name}`;const e=l.width/1e3;tooltip.style.left=10*n*e+10+"px",tooltip.style.top=10*a*e-30+"px",tooltip.style.display="block"}else tooltip.style.display="none"}
confirmBtn.addEventListener("click",(()=>{if(!selection)return void alert("Selecciona un √°rea");if(selection.soldInSelection>0)return void alert(`${selection.soldInSelection} bloques ocupados`);const e=selection.blocksX*selection.blocksY*getPriceForBlock(selection.zone);document.getElementById("totalPrice").textContent=e.toFixed(4);document.getElementById("ownerPriceNote").style.display=isOwner?"block":"none",document.getElementById("modal").style.display="block"}));
cancelBtn.addEventListener("click",(()=>{selection=null,selectionOverlay.style.display="none",selectionInfo.textContent="",selectionAmountSpan.textContent="-",confirmBtn.disabled=!0}));
document.getElementById("closeModal").addEventListener("click",(()=>{document.getElementById("modal").style.display="none",document.getElementById("paymentStatus").textContent=""}));
function resetPaymentUI(){const e=document.getElementById("payBtn");e.disabled=!1,e.textContent="üí∞ Pagar y Registrar"}
function resetAfterPurchase(){document.getElementById("modal").style.display="none",selection=null,selectionOverlay.style.display="none",selectionInfo.textContent="",selectionAmountSpan.textContent="-",confirmBtn.disabled=!0,document.getElementById("projectName").value="",document.getElementById("projectURL").value="",document.getElementById("projectLogo").value="",document.getElementById("paymentStatus").textContent="",resetPaymentUI()}
function showStatus(e,t="info"){const o=document.getElementById("paymentStatus");o.textContent=e,o.className=t}
document.getElementById("payBtn").addEventListener("click",(async()=>{const e=document.getElementById("projectName").value.trim(),t=document.getElementById("projectURL").value.trim(),o=document.getElementById("projectLogo").files[0],l=document.getElementById("payBtn");if(!selection)return void alert("No hay selecci√≥n");if(selection.soldInSelection>0)return void alert("Bloques ocupados");if(!e||!t||!o)return void alert("Completa todos los campos");if(!window.solana||!userPublicKey)return void alert("Conecta tu wallet");if(!MERCHANT_WALLET)return void alert("Error de configuraci√≥n");const n={minBlockX:selection.minBlockX,minBlockY:selection.minBlockY,maxBlockX:selection.maxBlockX,maxBlockY:selection.maxBlockY,blocksX:selection.blocksX,blocksY:selection.blocksY,zone:selection.zone,soldInSelection:selection.soldInSelection};try{l.disabled=!0,l.textContent="Procesando...",showStatus("üì§ Subiendo logo...","warning");const a=new FormData;a.append("file",o);const i=await fetch(`${API_BASE}/api/upload-logo`,{method:"POST",body:a}),r=await i.json();if(!i.ok||!r.ok)throw new Error(r.error||"Error subiendo logo");const s=r.url;showStatus("üí∞ Preparando...","warning");const c=n.blocksX*n.blocksY,d=getPriceForBlock(n.zone),S=Math.floor(c*d*solanaWeb3.LAMPORTS_PER_SOL),m=new solanaWeb3.Transaction;m.add(solanaWeb3.SystemProgram.transfer({fromPubkey:userPublicKey,toPubkey:new solanaWeb3.PublicKey(MERCHANT_WALLET),lamports:S})),m.feePayer=userPublicKey,showStatus("‚è≥ Blockhash...","warning");const u=await fetch(`${API_BASE}/api/get-latest-blockhash`,{method:"POST",headers:{"Content-Type":"application/json"}}),f=await u.json();if(!f.ok)throw new Error("Error blockhash");m.recentBlockhash=f.blockhash,showStatus("‚úçÔ∏è Firma en Phantom...","warning");const{signature:y}=await window.solana.signAndSendTransaction(m);showStatus("‚è≥ Confirmando...","warning");let g=!1,p=0;const b=30;for(;!g&&p<b;){try{const e=await fetch(`${API_BASE}/api/verify-transaction`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({signature:y})}),t=await e.json();if(t.ok&&t.confirmed){if(g=!0,t.status&&t.status.err)throw new Error("Transacci√≥n fall√≥");break}}catch(e){console.warn(e)}await new Promise((e=>setTimeout(e,1e3))),p++}g||showStatus("‚è≥ Guardando...","warning"),showStatus("üíæ Registrando...","warning");const I={signature:y,buyer:userPublicKey.toString(),metadata:{name:e,url:t,logo:s,selection:{minBlockX:n.minBlockX,minBlockY:n.minBlockY,blocksX:n.blocksX,blocksY:n.blocksY}},amount:S/solanaWeb3.LAMPORTS_PER_SOL,timestamp:Date.now(),confirmed:g},h=await fetch(`${API_BASE}/api/save-sale`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(I)}),k=await h.json();if(!h.ok||!k.ok)throw new Error(k.error||"Error guardando");showStatus(g?"‚úÖ ¬°Confirmado!":"‚úÖ ¬°Registrado!","success"),setTimeout((async()=>{resetAfterPurchase(),loadingEl.style.display="flex";try{await loadGridFromServer(),alert(g?"üéâ ¬°Compra exitosa!":"‚è≥ Registrado. Verifica en Phantom.\n\nhttps://solscan.io/tx/"+y)}catch(e){alert("‚ö†Ô∏è Recarga la p√°gina")}}),2e3)}catch(e){console.error("‚ùå",e);let t="Error en el pago";e.message?.includes("User rejected")?t="‚ùå Cancelado":e.message?.includes("insufficient")?t="‚ùå SOL insuficiente":e.message?.includes("Timeout")?t="‚è≥ Timeout - Verifica Phantom":e.message&&(t=`‚ùå ${e.message}`),showStatus(t,"error"),resetPaymentUI(),alert(t)}}));
canvas.addEventListener("click",(e=>{if(isDragging)return;const{rawX:t,rawY:o}=getMousePosInCanvas(e),l=Math.floor(t/10),n=Math.floor(o/10),a=blockData[blockIndex(l,n)];a&&confirm(`üöÄ ¬øVisitar ${a.name}?`)&&window.open(a.url,"_blank")}));
console.log("üöÄ Iniciando..."),loadConfig().then((()=>{loadGridFromServer()}));
  </script>
</body>
</html>
