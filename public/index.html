<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Million Grid en Solana - Compra píxeles y muestra tu proyecto">
  <title>Solana Million Grid</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f1115; color:#fff; margin:0; padding:0; }
    header { padding:12px 16px; background: #0b1020; display:flex; justify-content:space-between; align-items:center; }
    #canvas { background:#111; display:block; margin:12px auto; border:1px solid #333; }
    #controls { max-width:1000px; margin: 10px auto; display:flex; gap:8px; justify-content:center; }
    button { padding:10px 12px; border-radius:6px; border:none; cursor:pointer; background:#2b6cb0; color:#fff; }
    #status { text-align:center; margin:8px; color:#ffda79; }
  </style>
</head>
<body>
  <header>
    <div>Solana Million Grid</div>
    <div>
      <button id="connectBtn">Conectar wallet</button>
    </div>
  </header>

  <div id="controls">
    <button id="selectBtn">Seleccionar bloques</button>
    <button id="buyBtn" disabled>💳 Pagar y registrar</button>
    <div id="price" style="align-self:center;color:#ffd700">Precio: <span id="totalPrice">0.00</span> SOL</div>
  </div>

  <div style="max-width:1000px;margin:0 auto">
    <canvas id="canvas" width="1000" height="1000"></canvas>
    <div id="status"></div>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    const CANVAS_SIZE = 1000;
    const BLOCK_SIZE = 10;
    const BLOCKS_PER_SIDE = CANVAS_SIZE / BLOCK_SIZE;
    const PRICE_PER_BLOCK_SOL = 0.001; // ejemplo: ajustar en servidor/cliente según sea necesario

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const buyBtn = document.getElementById('buyBtn');
    const totalPriceEl = document.getElementById('totalPrice');

    let walletConnected = false;
    let userPublicKey = null;

    // Simple grid draw
    function drawGrid() {
      ctx.fillStyle = '#111';
      ctx.fillRect(0,0,CANVAS_SIZE,CANVAS_SIZE);
      ctx.strokeStyle = '#222';
      for (let x=0;x<=CANVAS_SIZE;x+=BLOCK_SIZE) {
        ctx.beginPath();
        ctx.moveTo(x,0); ctx.lineTo(x,CANVAS_SIZE); ctx.stroke();
      }
      for (let y=0;y<=CANVAS_SIZE;y+=BLOCK_SIZE) {
        ctx.beginPath();
        ctx.moveTo(0,y); ctx.lineTo(CANVAS_SIZE,y); ctx.stroke();
      }
    }
    drawGrid();

    let selection = null;
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / BLOCK_SIZE);
      const y = Math.floor((e.clientY - rect.top) / BLOCK_SIZE);
      selection = { x, y, w: 1, h: 1 };
      renderSelection();
      updatePrice();
      buyBtn.disabled = false;
    });

    canvas.addEventListener('mousemove', (e) => {
      // (opcional) expandir selección con Shift + mousemove
    });

    function renderSelection() {
      drawGrid();
      if (!selection) return;
      ctx.fillStyle = 'rgba(255,215,0,0.6)';
      ctx.fillRect(selection.x * BLOCK_SIZE, selection.y * BLOCK_SIZE, selection.w * BLOCK_SIZE, selection.h * BLOCK_SIZE);
    }

    function updatePrice() {
      if (!selection) { totalPriceEl.textContent = '0.00'; return; }
      const blocks = Math.max(1, selection.w * selection.h);
      const price = (blocks * PRICE_PER_BLOCK_SOL).toFixed(4);
      totalPriceEl.textContent = price;
    }

    // Wallet connect
    async function connectWallet() {
      if (!window.solana || !window.solana.isPhantom) {
        alert('Instala Phantom u otra wallet compatible con window.solana.');
        return;
      }
      try {
        const resp = await window.solana.connect();
        userPublicKey = resp.publicKey;
        walletConnected = true;
        connectBtn.textContent = 'Conectado: ' + userPublicKey.toString().slice(0,6) + '...';
        status('Wallet conectada');
        buyBtn.disabled = false;
      } catch (err) {
        console.error('Wallet connect error', err);
        status('Error conectando wallet');
      }
    }

    connectBtn.addEventListener('click', connectWallet);

    function status(msg, type='info') {
      statusEl.textContent = msg || '';
    }

    // Construir y enviar transacción simple (transfer) con memo JSON
    async function payAndRegister() {
      if (!walletConnected || !userPublicKey) return alert('Conecta la wallet primero');
      if (!selection) return alert('Selecciona bloques primero');

      const priceSOL = parseFloat(totalPriceEl.textContent);
      if (!priceSOL || priceSOL <= 0) return alert('Precio inválido');

      try {
        status('Preparando transacción...');
        const fromPubkey = userPublicKey;
        const merchant = window.MERCHANT_WALLET || ''; // opcional: inyectar desde server o config
        if (!merchant) return alert('Merchant wallet no configurada en el cliente');

        const toPubkey = new solanaWeb3.PublicKey(merchant);
        const lamports = Math.round(priceSOL * solanaWeb3.LAMPORTS_PER_SOL);

        const transferIx = solanaWeb3.SystemProgram.transfer({
          fromPubkey,
          toPubkey,
          lamports
        });

        // Memo JSON con selection
        const memoObj = {
          type: 'million-grid-sale',
          selection: {
            minBlockX: selection.x,
            minBlockY: selection.y,
            blocksX: selection.w,
            blocksY: selection.h
          },
          projectName: 'Mi Proyecto' // puedes recolectar este campo desde un formulario
        };
        const memoIx = new solanaWeb3.TransactionInstruction({
          keys: [],
          programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLmfcHr'),
          data: Buffer.from(JSON.stringify(memoObj), 'utf8')
        });

        const tx = new solanaWeb3.Transaction().add(transferIx, memoIx);
        tx.feePayer = fromPubkey;
        const { blockhash } = await connection.getLatestBlockhash('finalized');
        tx.recentBlockhash = blockhash;

        status('Por favor firma y envía la transacción en la wallet...');
        const signed = await window.solana.signAndSendTransaction(tx);
        const signature = signed.signature || signed;
        status('Transacción enviada: ' + signature);
        // Esperar confirmación y llamar al backend para verificiar y registrar
        status('Confirmando transacción y registrando venta...');

        // Llamada backend
        const payload = {
          signature,
          expectedAmountSOL: priceSOL,
          metadata: {
            name: memoObj.projectName,
            selection: memoObj.selection
          }
        };
        const resp = await fetch('/api/verify-purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (json.ok) {
          status('Compra verificada y registrada ✔️');
          console.log('Venta registrada:', json.sale);
        } else {
          status('Error registrando compra: ' + (json.error || 'unknown'));
          console.error('verify-purchase error', json);
        }

      } catch (err) {
        console.error('Error en pago:', err);
        status('Error en pago: ' + (err.message || err.toString()));
      }
    }

    buyBtn.addEventListener('click', payAndRegister);

    // Inicializar connection usada por ejemplo (usa devnet/mainnet según servidor)
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'), { commitment: 'confirmed' });

    // (Opcional) Exponer merchant wallet si el servidor inyecta valor dinámicamente
    window.MERCHANT_WALLET = '3d7w4r4irLaKVYd4dLjpoiehJVawbbXWFWb1bCk9nGCo'; // reemplazar en producción
    status('Listo');
  </script>
</body>
</html>
