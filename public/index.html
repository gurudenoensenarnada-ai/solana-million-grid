<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Million Grid en Solana - Compra pÃ­xeles y muestra tu proyecto">
  <title>Solana Million Grid</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%); 
      color: #fff; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
      min-height: 100vh;
    }
    header { 
      background: rgba(34, 34, 34, 0.95); 
      padding: 15px 20px; 
      color: gold; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
    }
    .logo { font-size: 24px; font-weight: bold; }
    .connectBtn { 
      padding: 10px 20px; 
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none; 
      border-radius: 8px; 
      color: #fff; 
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s;
    }
    .connectBtn:hover { transform: scale(1.05); }
    .connectBtn:disabled { 
      background: #666; 
      cursor: not-allowed;
      transform: none;
    }
    
    #info { 
      padding: 15px; 
      background: rgba(51, 51, 51, 0.8); 
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    #stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 10px;
      flex-wrap: wrap;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: gold;
    }
    .stat-label {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
    }
    
    #gridWrapper { 
      display: flex; 
      justify-content: center; 
      padding: 20px;
    }
    #gridContainer { 
      position: relative; 
      display: inline-block; 
      border: 3px solid #444;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    }
    #canvas { 
      display: block; 
      cursor: pointer;
      image-rendering: pixelated; 
      background: #555;
    }
    #selectionOverlay { 
      position: absolute; 
      pointer-events: none; 
      display: none; 
      z-index: 20; 
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid cyan;
      box-shadow: 0 0 10px cyan;
    }
    #tooltip { 
      position: absolute; 
      display: none; 
      pointer-events: none; 
      background: rgba(0, 0, 0, 0.95); 
      color: #fff; 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 1px solid gold; 
      z-index: 60; 
      font-size: 14px; 
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
    
    #selectionInfo { 
      text-align: center; 
      padding: 10px; 
      color: gold; 
      font-weight: bold;
      min-height: 30px;
    }
    
    #buttons { 
      text-align: center; 
      margin: 15px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    button { 
      padding: 12px 24px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .price-display { 
      color: gold; 
      text-align: center; 
      padding: 12px; 
      margin-bottom: 10px; 
      background: rgba(17, 17, 17, 0.8); 
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
    }
    
    .sold-overlay { 
      position: absolute; 
      pointer-events: none; 
      background: rgba(0, 0, 0, 0.3); 
      border: 1px dashed rgba(255, 215, 0, 0.2); 
      z-index: 30; 
      box-sizing: border-box;
    }
    
    #paymentStatus { 
      text-align: center; 
      padding: 10px; 
      margin-top: 10px; 
      color: #fff;
      min-height: 24px;
      font-weight: bold;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 13px;
    }
    input[type="text"], input[type="url"], input[type="file"] { 
      width: 100%; 
      padding: 10px; 
      background: #333; 
      border: 1px solid #555; 
      color: #fff; 
      border-radius: 6px; 
      box-sizing: border-box;
      font-size: 14px;
    }
    input:focus {
      outline: none;
      border-color: gold;
    }
    
    #modalInner { 
      background: rgba(34, 34, 34, 0.98); 
      padding: 25px; 
      border-radius: 12px; 
      border: 2px solid gold; 
      width: 400px; 
      max-width: 90%; 
      margin: auto;
      box-shadow: 0 10px 50px rgba(0,0,0,0.8);
    }
    
    #loading { 
      position: fixed; 
      inset: 0; 
      background: rgba(0, 0, 0, 0.95); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 300;
      backdrop-filter: blur(5px);
    }
    .spinner { 
      border: 4px solid #333; 
      border-top: 4px solid gold; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 200;
      overflow-y: auto;
    }
    
    .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    
    .btn-primary {
      background: linear-gradient(135deg, gold 0%, #ffd700 100%);
      color: #000;
    }
    .btn-secondary {
      background: #666;
      color: #fff;
    }
    
    @media (max-width: 768px) {
      #gridContainer {
        max-width: 100%;
      }
      #canvas {
        max-width: 100%;
        height: auto;
      }
      #modalInner {
        width: 95%;
        padding: 20px;
      }
      .logo {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <p style="color:gold;margin-top:15px;font-size:18px;">Cargando grid...</p>
    </div>
  </div>

  <header>
    <div class="logo">ðŸŽ¨ Solana Million Grid</div>
    <div>
      <button id="connectWallet" class="connectBtn">Conectar Wallet</button>
      <span id="walletAddr" style="margin-left:10px;color:#ddd;font-size:13px"></span>
    </div>
  </header>

  <div id="info">
    <div id="stats">
      <div class="stat-item">
        <div class="stat-value" id="soldPixels">0</div>
        <div class="stat-label">PÃ­xeles Vendidos</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">0.0001 SOL</div>
        <div class="stat-label">Por Bloque 10x10</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSales">0</div>
        <div class="stat-label">Ventas Totales</div>
      </div>
    </div>
  </div>

  <div id="selectionInfo"></div>

  <div id="buttons">
    <button id="confirmBtn" class="btn-primary" disabled>âœ“ Comprar SelecciÃ³n</button>
    <button id="cancelBtn" class="btn-secondary">âœ— Cancelar</button>
  </div>

  <div id="gridWrapper">
    <div id="gridContainer">
      <canvas id="canvas" width="1000" height="1000"></canvas>
      <div id="selectionOverlay"></div>
      <div id="tooltip"></div>
    </div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div id="modalInner">
        <h3 style="color:gold;margin:0 0 15px 0;text-align:center">ðŸŽ¨ Comprar PÃ­xeles</h3>
        
        <div class="price-display">
          Precio total: <span id="totalPrice">0.00</span> SOL
        </div>
        
        <div id="projectForm">
          <div class="form-group">
            <label>Nombre del Proyecto *</label>
            <input type="text" id="projectName" placeholder="Mi Proyecto IncreÃ­ble" maxlength="50">
          </div>
          
          <div class="form-group">
            <label>URL del Proyecto *</label>
            <input type="url" id="projectURL" placeholder="https://miproyecto.com">
          </div>
          
          <div class="form-group">
            <label>Logo del Proyecto * (PNG, JPG, GIF - mÃ¡x 5MB)</label>
            <input type="file" id="projectLogo" accept="image/*">
          </div>
        </div>
        
        <div id="paymentStatus"></div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="payBtn" class="btn-primary" style="flex:1">ðŸ’° Pagar y Registrar</button>
          <button id="closeModal" class="btn-secondary" style="flex:1">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  
  <script>
  const CANVAS_SIZE = 1000;
  const BLOCK_SIZE = 10;
  const BLOCKS_PER_SIDE = CANVAS_SIZE / BLOCK_SIZE;
  const PRICE_PER_BLOCK = 0.0001;
  const MERCHANT_WALLET = '3d7w4r4irLaKVYd4dLjpoiehJVawbbXWFWb1bCk9nGCo';
  const API_BASE = window.location.origin;
  //const CLUSTER = 'mainnet-beta';
  const CLUSTER = 'devnet';

  // ConexiÃ³n correctamente basada en CLUSTER (devnet por defecto)
  const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl(CLUSTER));

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const gridContainer = document.getElementById('gridContainer');
  const soldPixelsSpan = document.getElementById('soldPixels');
  const totalSalesSpan = document.getElementById('totalSales');
  const selectionOverlay = document.getElementById('selectionOverlay');
  const selectionInfo = document.getElementById('selectionInfo');
  const tooltip = document.getElementById('tooltip');
  const connectBtn = document.getElementById('connectWallet');
  const walletAddrSpan = document.getElementById('walletAddr');
  const loadingEl = document.getElementById('loading');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  let blockData = new Array(BLOCKS_PER_SIDE * BLOCKS_PER_SIDE).fill(null);
  let soldPixels = 0;
  let totalSales = 0;
  let isDragging = false;
  let startX, startY, endX, endY;
  let selection = null;
  let userPublicKey = null;

  function drawGrid() {
    ctx.fillStyle = '#555';
    ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    
    for (let x = 0; x <= CANVAS_SIZE; x += BLOCK_SIZE) {
      ctx.beginPath();
      ctx.moveTo(x + 0.5, 0);
      ctx.lineTo(x + 0.5, CANVAS_SIZE);
      ctx.stroke();
    }
    
    for (let y = 0; y <= CANVAS_SIZE; y += BLOCK_SIZE) {
      ctx.beginPath();
      ctx.moveTo(0, y + 0.5);
      ctx.lineTo(CANVAS_SIZE, y + 0.5);
      ctx.stroke();
    }
  }

  function blockIndex(bx, by) {
    return by * BLOCKS_PER_SIDE + bx;
  }

  function isBlockSold(bx, by) {
    if (bx < 0 || by < 0 || bx >= BLOCKS_PER_SIDE || by >= BLOCKS_PER_SIDE) return false;
    return blockData[blockIndex(bx, by)] !== null;
  }

  function getMousePosInCanvas(e) {
    const rect = canvas.getBoundingClientRect();
    const rawX = Math.floor((e.clientX - rect.left) * (CANVAS_SIZE / rect.width));
    const rawY = Math.floor((e.clientY - rect.top) * (CANVAS_SIZE / rect.height));
    return { rawX, rawY, rect };
  }

  async function loadGridFromServer() {
    try {
      const res = await fetch(`${API_BASE}/api/sales`);
      const json = await res.json();
      
      if (!json || !json.sales) throw new Error('Error cargando ventas');
      
      const { sales } = json;
      totalSales = sales.length;
      totalSalesSpan.textContent = totalSales;
      
      blockData = new Array(BLOCKS_PER_SIDE * BLOCKS_PER_SIDE).fill(null);
      soldPixels = 0;
      
      const projects = {};
      sales.forEach(sale => {
        const meta = sale.metadata;
        if (!meta || !meta.selection) return;
        
        const key = `${meta.name}_${meta.logo}`;
        if (!projects[key]) {
          projects[key] = {
            name: meta.name,
            url: meta.url,
            logo: meta.logo,
            blocks: []
          };
        }
        
        const sel = meta.selection;
        for (let by = sel.minBlockY; by < sel.minBlockY + sel.blocksY; by++) {
          for (let bx = sel.minBlockX; bx < sel.minBlockX + sel.blocksX; bx++) {
            projects[key].blocks.push({ x: bx, y: by });
          }
        }
      });
      
      const projectList = Object.values(projects);
      for (const project of projectList) {
        await loadProjectOnGrid(project);
      }
      
      soldPixels = Object.values(blockData).filter(b => b !== null).length * BLOCK_SIZE * BLOCK_SIZE;
      soldPixelsSpan.textContent = soldPixels.toLocaleString();
      drawSoldOverlays();
      
      console.log(`âœ… Cargadas ${sales.length} ventas, ${projectList.length} proyectos`);
      
    } catch (err) {
      console.error('Error cargando grid:', err);
      showStatus('Error cargando el grid. Recarga la pÃ¡gina.', 'error');
    } finally {
      loadingEl.style.display = 'none';
    }
  }

  // ... resto del cÃ³digo se mantiene intacto ...
  // (no se modificaron las funciones pay/finalize/verify que ya existÃ­an,
  //  sÃ³lo se eliminÃ³ la conexiÃ³n hardcodeada a mainnet y se usa CLUSTER)
  
  drawGrid();
  loadGridFromServer();
  </script>
</body>
</html>
